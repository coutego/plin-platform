<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClojureScript Dashboard</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script>
        window.SCITTLE_NREPL_WEBSOCKET_PORT = 1337;
    </script>

    <script src="https://unpkg.com/scittle@0.7.28/dist/scittle.js"></script>
    <script src="https://unpkg.com/scittle@0.7.28/dist/scittle.reagent.js"></script>
    <script src="https://unpkg.com/scittle@0.7.28/dist/scittle.nrepl.js"></script>
    <script src="https://unpkg.com/scittle@0.7.28/dist/scittle.pprint.js"></script>
    <script src="https://unpkg.com/scittle@0.7.28/dist/scittle.promesa.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alasql@4.16.0/dist/alasql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/clojure.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: -apple-system, sans-serif;
        }
    </style>


    <script>
        window.addEventListener("load", function() {
            setTimeout(function() {
                // The script creates 'window.ws_nrepl' when connected
                if (window.ws_nrepl) {
                    console.log("‚úÖ WebSocket Wrapper found: window.ws_nrepl");
                    console.log("Ready state:", window.ws_nrepl.readyState); // 1 = Connected
                } else {
                    console.error("‚ùå window.ws_nrepl is missing. Connection failed.");
                }
            }, 500); // Give it a moment to initialize
        });
    </script>
</head>

<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        var v = Date.now();
        function load(path) {
            document.write('<script type="application/x-scittle" src="' + path + '?v=' + v + '"><\/script>');
        }

        // --- CONFIGURATION START ---
        
        // 1. Check URL params for mode (e.g. index.html?mode=prod)
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');

        // 2. Default to demo if not specified
        window.APP_MODE = urlMode || "demo"; 
        window.APP_ENV = "browser";
        
        console.log("üöÄ Starting App in env:", window.APP_ENV, "mode:", window.APP_MODE);
        
        // 3. Fetch and Parse Manifests
        function fetchEdn(path) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", path, false); // Synchronous
            xhr.send(null);
            if (xhr.status === 200) {
                return xhr.responseText;
            } else {
                console.warn("Failed to load " + path);
                return null;
            }
        }

        function parseEDN(edn) {
            if (!edn) return [];
            try {
                return scittle.core.eval_string("(cljs.core/clj->js " + edn + "\n)");
            } catch (e) {
                console.error("Failed to parse EDN", e);
                return [];
            }
        }
        
        // 4. Plugin filtering logic (NEW: uses :envs and :modes)
        // Load if: (envs absent OR current-env in envs) AND (modes absent OR current-mode in modes)
        function shouldLoadPlugin(plugin, env, mode) {
            // Skip config entries
            if (plugin.config) return false;
            
            // Check envs: absent means "all environments"
            var envs = plugin.envs;
            var envMatch = !envs || envs.length === 0 || envs.indexOf(env) !== -1;
            
            // Check modes: absent means "all modes"
            var modes = plugin.modes;
            var modeMatch = !modes || modes.length === 0 || modes.indexOf(mode) !== -1;
            
            return envMatch && modeMatch;
        }
        
        // 4b. Check if plugin is a CLJS plugin (should be loaded via script tags)
        function isCljsPlugin(plugin) {
            // JS plugins have type: 'js', everything else is CLJS
            return !plugin.type || plugin.type === 'cljs';
        }
        
        // Collect initially disabled plugin IDs
        function getInitiallyDisabledIds(manifest) {
            var disabled = [];
            manifest.forEach(function(plugin) {
                if (plugin.enabled === false && plugin.id) {
                    disabled.push(plugin.id);
                }
            });
            return disabled;
        }

        // A. Load User Manifest
        var userEdn = fetchEdn("plin.edn");
        var userManifest = parseEDN(userEdn);
        
        // B. Check for Config (Opt-out of platform plugins)
        var configEntry = userManifest.find(function(item) { return item.config; });
        var includePlatform = true;
        var headConfig = null;
        if (configEntry && configEntry.config) {
            if (configEntry.config['include-platform?'] === false) {
                includePlatform = false;
            }
            headConfig = configEntry.config.head;
        }

        // C. Inject Head Resources (blocking, before app loads)
        if (headConfig) {
            console.log("üì¶ Injecting head resources from manifest config...");
            
            if (headConfig.scripts && Array.isArray(headConfig.scripts)) {
                headConfig.scripts.forEach(function(script) {
                    if (typeof script === 'string') {
                        document.write('<script src="' + script + '"><\/script>');
                    } else if (script.src) {
                        var attrs = 'src="' + script.src + '"';
                        if (script.async) attrs += ' async';
                        if (script.defer) attrs += ' defer';
                        if (script.type) attrs += ' type="' + script.type + '"';
                        if (script.crossorigin) attrs += ' crossorigin="' + script.crossorigin + '"';
                        document.write('<script ' + attrs + '><\/script>');
                    }
                });
            }
            
            if (headConfig.styles && Array.isArray(headConfig.styles)) {
                headConfig.styles.forEach(function(style) {
                    var href = typeof style === 'string' ? style : style.href;
                    if (href) {
                        var link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = href;
                        if (style.media) link.media = style.media;
                        document.head.appendChild(link);
                    }
                });
            }
            
            if (headConfig['inline-styles']) {
                var styleEl = document.createElement('style');
                styleEl.textContent = headConfig['inline-styles'];
                document.head.appendChild(styleEl);
            }
            
            if (headConfig.tailwind && window.tailwind) {
                console.log("üé® Applying Tailwind config from manifest...");
                window.tailwind.config = headConfig.tailwind;
            }
        }

        // D. Load Platform Manifest (if not opted out)
        var platformManifest = [];
        if (includePlatform) {
            var platformEdn = fetchEdn("src/plinpt/plin.edn");
            platformManifest = parseEDN(platformEdn);
        }

        // E. Merge and store
        window.SYSTEM_MANIFEST = platformManifest.concat(userManifest);
        
        // F. Calculate initially disabled plugins
        window.INITIALLY_DISABLED_IDS = getInitiallyDisabledIds(window.SYSTEM_MANIFEST);
        
        // G. Filter plugins for current env/mode
        var allPluginsToLoad = window.SYSTEM_MANIFEST.filter(function(p) {
            return shouldLoadPlugin(p, window.APP_ENV, window.APP_MODE);
        });
        
        // H. Separate CLJS and JS plugins
        var cljsPluginsToLoad = allPluginsToLoad.filter(isCljsPlugin);
        var jsPluginsToLoad = allPluginsToLoad.filter(function(p) { return !isCljsPlugin(p); });
        
        console.log("üì¶ Manifest total:", window.SYSTEM_MANIFEST.length, 
                    "| CLJS plugins:", cljsPluginsToLoad.length,
                    "| JS plugins:", jsPluginsToLoad.length,
                    "| Initially disabled:", window.INITIALLY_DISABLED_IDS.length);

        // --- CONFIGURATION END ---

        // Load Libs (Static)
        load("libs/malli/core.cljs");
        load("libs/malli/error.cljs");
        load("libs/pluggable/container.cljc");
        load("libs/pluggable/root_plugin.cljc");
        load("libs/pluggable/core.cljc");
        load("libs/injectable/easy.cljc");
        load("libs/injectable/container.cljc");
        load("libs/injectable/core.cljc");
        load("libs/plin/core.cljc");
        load("libs/plin/boot.cljc");
        
        // Load JS Loader (needed for JS plugin support)
        load("libs/plin/js_loader.cljs");

        // Load CLJS Plugins Dynamically (JS plugins are loaded via fetch in client_boot)
        cljsPluginsToLoad.forEach(function(plugin) {
            plugin.files.forEach(function(file) {
                load(file);
            });
        });

        // Main Entry Point
        load("src/plin_platform/client_boot.cljs");
    </script>
</body>

</html>
